<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OOBjectif R1P • PROTOCOLE ÉLITE 2026</title>

    https://fonts.googleapis.com
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani0;600;700&family=Orbitron:wght@400;700;900&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap

    <script src="https://cdn.jsdelivr.net/npm/@base-js@2/dist/umd/supabase.js</script>
    https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js</script>
    https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js</script>
    https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js</script>

<style>
/* … (styles inchangés, conservés tels quels) … */

/* ─── CELEBRATION OVERLAYS ─── */
#mxo{position:fixed;inset:0;z-index:500;pointer-events:none;display:none;overflow:hidden;}
.mcol{position:absolute;top:0;font-family:var(--fm);font-size:.7rem;color:var(--p);writing-mode:vertical-rl;animation:matrixDrop 1.6s linear forwards;}
#flo{position:fixed;inset:0;z-index:490;pointer-events:none;display:none;background:rgba(247,147,30,.04);}
#holo{position:fixed;top:50%;left:50%;z-index:480;pointer-events:none;display:none;transform:translate(-50%,-50%);}
.hring{position:absolute;border-radius:50%;border:1.5px solid rgba(247,147,30,.3);animation:holoPulse .7s ease-out forwards;}
</style>
</head>
<body>

<div id="cur"></div>
<div id="gb"></div>
<canvas id="sc"></canvas>

<!-- Notification live -->
<div id="notif" style="position:fixed;bottom:24px;right:24px;z-index:550;display:none;max-width:280px;">
    <div style="background:rgba(6,12,28,.97);border:1px solid rgba(247,147,30,.3);border-radius:8px;padding:12px 16px;box-shadow:0 8px 32px rgba(0,0,0,.6);display:flex;align-items:center;gap:10px;">
        <div style="width:8px;height:8px;background:var(--grn);border-radius:50%;box-shadow:0 0 8px var(--grn);flex-shrink:0;"></div>
        <div id="notif-txt" style="font-family:var(--fm);font-size:.62rem;color:rgba(255,255,255,.75);letter-spacing:1px;"></div>
    </div>
</div>

<!-- Mega milestone overlay -->
<div id="milestone" style="position:fixed;inset:0;z-index:700;display:none;pointer-events:none;align-items:center;justify-content:center;flex-direction:column;">
    <div id="ms-inner" style="text-align:center;">
        <div id="ms-num" style="font-family:'Orbitron',monospace;font-size:8rem;font-weight:900;color:var(--gold);line-height:1;text-shadow:0 0 60px rgba(251,191,36,.8),0 0 120px rgba(247,147,30,.4);"></div>
        <div id="ms-lbl" style="font-family:'Orbitron',monospace;font-size:1.4rem;font-weight:700;color:white;letter-spacing:6px;margin-top:8px;"></div>
        <div id="ms-sub" style="font-family:'Space Mono',monospace;font-size:.7rem;color:rgba(255,255,255,.5);letter-spacing:3px;margin-top:12px;"></div>
    </div>
</div>

<!-- Toast -->
<div id="toast">
    <div class="tbox">
        <div class="tpilot" id="tp"></div>
        <div class="tmsg"   id="tm"></div>
        <div class="tcnt"   id="tc"></div>
        <div class="tsub"   id="ts"></div>
    </div>
</div>

<!-- ✅ Overlays pour les célébrations (AJOUTÉS) -->
<div id="mxo"></div>
<div id="flo"></div>
<div id="holo"></div>

<!-- ══════════════════════ LOGIN ══════════════════════ -->
<div id="lm">
    <!-- … (login inchangé) … -->
</div>

<!-- ══════════════════════ APP ══════════════════════ -->
<div id="app" style="display:none;opacity:0;">
    <!-- … (app inchangé) … -->
</div>

<!-- ══════════════════════ ADMIN PW ══════════════════════ -->
<div id="pwo">
    <!-- … (inchangé) … -->
</div>

<!-- ══════════════════════ ADMIN PANEL ══════════════════════ -->
<div id="adm">
    <!-- … (inchangé) … -->
</div>

<script>
/* ═══════════════════════════════════════
   CONFIG
════════════════════════════════════════ */
const SB_URL = "https://ydcfjlogsbkmzzzkxvgo.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkY2ZqbG9nc2JrbXp6emt4dmdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMDQ0MDksImV4cCI6MjA4Nzc4MDQwOX0.nF-ZZWucb6BMQvGxZ1iK1SjYyrZ-0dW0fAaYw9cPzls";
const _sb    = supabase.createClient(SB_URL, SB_KEY);
const ADMIN_PW = "oob2026"; // ← modifier ici

/* … (données et constantes inchangées) … */

let user = { name:"", team:"" };
let ses  = 0;
let week = 0;
let t0   = Date.now();
let board = [];
let prevLeader = null;
let lastFeedIds = new Set();

/* ═══════════════════════════════════════
   CURSOR
════════════════════════════════════════ */
const cur = document.getElementById('cur');
document.addEventListener('mousemove', e => {
    cur.style.left = e.clientX+'px';
    cur.style.top  = e.clientY+'px';
});
document.querySelectorAll('button,input,textarea').forEach(el=>{
    el.addEventListener('mouseenter',()=>cur.classList.add('big'));
    el.addEventListener('mouseleave',()=>cur.classList.remove('big'));
});

/* ═══════════════════════════════════════
   THREE.JS STARFIELD
════════════════════════════════════════ */
let SR, SS, SC, SM;
const N=6000;
let SP, SV, SA;

function initStars(){
    SS = new THREE.Scene();
    SC = new THREE.PerspectiveCamera(60,innerWidth/innerHeight,1,1000);
    SC.position.z=1; SC.rotation.x=Math.PI/2;
    SR = new THREE.WebGLRenderer({canvas:document.getElementById('sc'),antialias:false});
    SR.setPixelRatio(Math.min(devicePixelRatio,2));
    SR.setSize(innerWidth,innerHeight);

    const geo = new THREE.BufferGeometry();
    SP=new Float32Array(N*3); SV=new Float32Array(N); SA=new Float32Array(N);
    for(let i=0;i<N;i++){
        SP[i*3]=Math.random()*600-300;
        SP[i*3+1]=Math.random()*600-300;
        SP[i*3+2]=Math.random()*600-300;
        SV[i]=0; SA[i]=0.01;
    }
    geo.setAttribute('position',new THREE.BufferAttribute(SP,3));
    SM=new THREE.Points(geo,new THREE.PointsMaterial({color:0xaaaacc,size:.5,transparent:true,depthWrite:false}));
    SS.add(SM);
    window.addEventListener('resize',()=>{SC.aspect=innerWidth/innerHeight;SC.updateProjectionMatrix();SR.setSize(innerWidth,innerHeight);});
    animS();
}
function animS(){
    const p=SM.geometry.attributes.position;
    for(let i=0;i<N;i++){SV[i]+=SA[i];p.array[i*3+1]-=SV[i];if(p.array[i*3+1]<-200){p.array[i*3+1]=200;SV[i]=0;}}
    p.needsUpdate=true; SM.rotation.y+=.0004;
    SR.render(SS,SC); requestAnimationFrame(animS);
}

/* ✅ Correction ternaires mal écrits dans hyper() */
function hyper(on){
    const ta = on ? 0.9 : 0.01;
    const ts = on ? 4   : 0.5;
    const o  = { v: on ? 0.01: 0.9 };
    gsap.to(o,{
        v: ta,
        duration: on ? 2.2 : 1.2,
        ease: on ? "power4.in" : "power2.out",
        onUpdate: ()=>{ for(let i=0;i<N;i++) SA[i]=o.v; }
    });
    gsap.to(SM.material,{ size: ts, duration: on ? 2 : 1 });
}

/* ═══════════════════════════════════════
   CLOCK
════════════════════════════════════════ */
function startClock(){
    const el=document.getElementById('clk');
    setInterval(()=>{el.textContent=new Date().toTimeString().slice(0,8);},1000);
}

/* ═══════════════════════════════════════
   LOGIN
════════════════════════════════════════ */
function doLogin(){
    const raw=(document.getElementById('pi').value||'').trim().toLowerCase();
    const err=document.getElementById('lerr');
    err.textContent='';
    if(!raw){err.textContent='⚠ ENTREZ VOTRE IDENTIFIANT';return;}
    if(!TEAM_MAP[raw]){err.textContent='✕ PILOTE NON RECONNU — CONTACTEZ ADMIN';shake('pi');return;}

    user.name=raw.charAt(0).toUpperCase()+raw.slice(1);
    user.team=TEAM_MAP[raw];

    const btn=document.getElementById('blbtn');
    btn.disabled=true; btn.textContent='INITIALISATION...';

    hyper(true);
    gsap.to('#lm',{opacity:0,duration:1,delay:1.9});

    setTimeout(()=>{
        document.getElementById('lm').style.display='none';
        const ap=document.getElementById('app');
        ap.style.display='grid';
        gsap.fromTo(ap,{opacity:0},{opacity:1,duration:.8});
        setTimeout(()=>hyper(false),700);
        boot();
        startClock();
    },2700);
}
document.getElementById('pi').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

/* … (boot, refreshAll, etc. restent identiques) … */

/* ═══════════════════════════════════════
   TOAST
════════════════════════════════════════ */
function showToast(msg,sub,count,isErr=false){
    const el=document.getElementById('toast');
    document.getElementById('tp').textContent=user.name.toUpperCase()+' —';
    document.getElementById('tm').textContent=msg;
    document.getElementById('tc').innerHTML=count?`<span>${count}</span> R1P`:'';
    document.getElementById('ts').textContent=sub||'';
    document.getElementById('tm').style.color=isErr?'var(--red)':'var(--p)';
    el.style.display='block';
    gsap.fromTo(el,{scale:0,opacity:0},{scale:1,opacity:1,duration:.55,ease:'back.out(2.4)'});
    setTimeout(()=>gsap.to(el,{opacity:0,scale:.85,duration:.4,onComplete:()=>el.style.display='none'}),4200);
}

/* ✅ Helper anti-crash pour s’assurer que l’élément existe */
function ensureEl(id){
    let el = document.getElementById(id);
    if(!el){
        el = document.createElement('div');
        el.id = id;
        document.body.appendChild(el);
    }
    return el;
}

/* ═══════════════════════════════════════
   CELEBRATIONS
════════════════════════════════════════ */
function celebrate(type){
    const C=['#F7931E','#ffffff','#fbbf24','#ff6200','#1a3a6b','#60a5fa'];
    switch(type){

    case 'confetti_rain':
        confetti({particleCount:120,spread:80,origin:{y:.6},colors:C});
        setTimeout(()=>confetti({particleCount:80,spread:110,origin:{x:.15,y:.7},colors:C}),300);
        setTimeout(()=>confetti({particleCount:80,spread:110,origin:{x:.85,y:.7},colors:C}),500);
        break;

    case 'confetti_cannon':
        [{x:0,y:.5},{x:1,y:.5}].forEach((o,i)=>setTimeout(()=>confetti({
            particleCount:100,angle:i?120:60,spread:55,origin:o,colors:C,startVelocity:55
        }),i*200));
        break;

    case 'matrix': {
        const mxo = ensureEl('mxo');
        mxo.style.display='block'; mxo.innerHTML='';
        const ch='01アイウR1POOBビグデ';
        for(let i=0;i<35;i++){
            const c=document.createElement('div');
            c.className='mcol';
            c.style.cssText=`left:${Math.random()*100}vw;animation-duration:${.7+Math.random()*.9}s;animation-delay:${Math.random()*.4}s;opacity:${.3+Math.random()*.7};font-size:${.55+Math.random()*.4}rem;`;
            c.textContent=Array.from({length:~~(Math.random()*14+5)},()=>ch[~~(Math.random()*ch.length)]).join('');
            mxo.appendChild(c);
        }
        setTimeout(()=>{mxo.style.display='none';mxo.innerHTML='';},2200);
        break;
    }

    case 'lightning': {
        const flo = ensureEl('flo');
        flo.style.display='block';
        gsap.fromTo(flo,{opacity:0},{keyframes:[{opacity:.7,duration:.05},{opacity:0,duration:.05},{opacity:.5,duration:.04},{opacity:0,duration:.06},{opacity:.9,duration:.04},{opacity:0,duration:.1}],
            onComplete:()=>flo.style.display='none'});
        gsap.fromTo('#app',{x:0},{keyframes:[{x:-10},{x:10},{x:-7},{x:7},{x:-4},{x:4},{x:0}],duration:.38,ease:'none'});
        break;
    }

    case 'holo': {
        const holo = ensureEl('holo');
        holo.style.display='block'; holo.innerHTML='';
        [60,130,210,300,400].forEach((r,i)=>{
            const ring=document.createElement('div');
            ring.className='hring';
            ring.style.cssText=`width:${r*2}px;height:${r*2}px;top:${-r}px;left:${-r}px;animation-delay:${i*.07}s;border-color:${i%2===0?'rgba(247,147,30,.28)':'rgba(251,191,36,.14)'};`;
            holo.appendChild(ring);
        });
        setTimeout(()=>{holo.style.display='none';holo.innerHTML='';},1600);
        break;
    }

    case 'spotlight':
        gsap.fromTo('#app',{filter:'brightness(1)'},{filter:'brightness(1.4)',duration:.15,yoyo:true,repeat:3,ease:'none',onComplete:()=>document.getElementById('app').style.filter=''});
        break;

    case 'zoom':
        gsap.fromTo('#app',{scale:1},{keyframes:[{scale:1.035,duration:.14},{scale:.985,duration:.1},{scale:1,duration:.22}],ease:'power2.out'});
        confetti({particleCount:60,spread:70,origin:{y:.6},colors:C});
        break;

    case 'particles':
        confetti({particleCount:120,startVelocity:35,spread:360,origin:{y:.5,x:.5},gravity:.55,colors:C,shapes:['circle','square']});
        break;

    case 'color_flash':
        document.documentElement.style.setProperty('--p','#22c55e');
        confetti({particleCount:80,spread:80,origin:{y:.6},colors:['#22c55e','#fff','#fbbf24']});
        setTimeout(()=>document.documentElement.style.setProperty('--p','#F7931E'),700);
        break;

    case 'star_burst':
        confetti({particleCount:80,spread:70,origin:{y:.6},colors:C,shapes:['star']});
        setTimeout(()=>confetti({particleCount:60,angle:60,spread:55,origin:{x:0,y:.5},colors:C,shapes:['star']}),250);
        setTimeout(()=>confetti({particleCount:60,angle:120,spread:55,origin:{x:1,y:.5},colors:C,shapes:['star']}),450);
        break;

    default:
        confetti({particleCount:100,spread:70,origin:{y:.6},colors:C});
    }
}

/* … (le reste de ton code reste inchangé) … */

/* ═══════════════════════════════════════
   BOOT
════════════════════════════════════════ */
window.onload=()=>{initStars();loadPilotCount();};
</script>
</body>
</html>
