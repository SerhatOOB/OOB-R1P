<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OOBJECTIF R1P</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --primary: #F7931E;
            --gold: #fbbf24;
            --darkblue: #1e3a8a;
            --dark: #0a0f1c;
            --glass: rgba(15,23,42,0.95);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: radial-gradient(circle at top right, #1e1b4b, #05070a);
            color: #f8fafc;
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
        }

        .container {
            position:relative; z-index:10; height:100vh;
            display:grid; grid-template-rows:auto 1fr auto;
            max-width:1300px; margin:0 auto; padding:1.5rem;
        }

        /* LOGO STYLIS√â */
        .logo { font-size: 3rem; font-weight: 900; letter-spacing: -3px; line-height: 1; margin-bottom: 5px; }
        .logo .oob { color: white; }
        .logo .jectif { background: linear-gradient(90deg, var(--gold), #facc15); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo .r1p { color: var(--primary); border: 1px solid var(--primary); padding: 2px 12px; border-radius: 50px; font-size: 0.6em; margin-left: 10px; }

        main { display: grid; grid-template-columns: 300px 1fr 300px; gap: 1.5rem; height: 100%; overflow: hidden; }

        .glass {
            background: var(--glass); backdrop-filter: blur(40px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 28px;
            padding: 1.5rem; box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }

        /* BOUTON R1P LUXE */
        #r1p-btn {
            background: linear-gradient(145deg, var(--primary), #ea580c);
            color: white; font-size: 1.4rem; font-weight: 900; padding: 18px;
            border-radius: 20px; border: none; cursor: pointer;
            box-shadow: 0 10px 30px rgba(247,147,30,0.4); margin-top: 1rem;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #r1p-btn:hover { transform: scale(1.05); box-shadow: 0 15px 45px rgba(247,147,30,0.6); }

        .feed-item { padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.03); border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        /* PROGRESS BARS */
        .progress-bar { background: rgba(255,255,255,0.05); height: 8px; border-radius: 10px; margin: 5px 0 15px; overflow: hidden; }
        .progress-fill { background: var(--primary); height: 100%; width: 0%; transition: width 1s ease; }

        #toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; color: black; padding: 30px 50px; border-radius: 24px;
            font-size: 1.8rem; font-weight: 900; text-align: center; z-index: 10000;
            display: none; box-shadow: 0 0 100px rgba(247,147,30,0.5); border: 4px solid var(--primary);
        }

        .admin-key { position: absolute; bottom: 20px; right: 20px; cursor: pointer; opacity: 0.2; transition: 0.3s; font-size: 1.2rem; }
        .admin-key:hover { opacity: 1; transform: scale(1.2); }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="login-modal" style="position:fixed;inset:0;background:var(--dark);z-index:99999;display:flex;align-items:center;justify-content:center;">
        <div class="glass" style="width:350px;text-align:center; position: relative;">
            <h2 style="font-size:2rem;margin-bottom:1.5rem;">OOBjectif R1P</h2>
            <input id="prenom-input" type="text" placeholder="Ton pr√©nom..." style="width:100%;padding:15px;border-radius:15px;border:none;background:rgba(255,255,255,0.07);color:white;font-size:1.2rem;text-align:center;outline:none;">
            <button onclick="validatePrenom()" style="margin-top:1.5rem;padding:15px;background:var(--primary);color:white;border:none;border-radius:15px;font-weight:900;width:100%;cursor:pointer;">D√âCOLLER üöÄ</button>
            <p id="login-error" style="color:#ef4444;margin-top:1rem;"></p>
            <div class="admin-key" onclick="askAdminCode()">üîë</div>
        </div>
    </div>

    <div class="container" id="main-app" style="display:none; opacity:0;">
        <header>
            <h1 class="logo"><span class="oob">OOB</span><span class="jectif">jectif</span><span class="r1p">R1P</span></h1>
            <p style="opacity:0.6;">Chaque prise est une nouvelle victoire.</p>
        </header>

        <main id="shake-container">
            <div class="glass">
                <div id="avatar" style="width:100px;height:100px;margin:0 auto 1rem;border-radius:50%;background:var(--primary);font-size:3.5rem;display:flex;align-items:center;justify-content:center;font-weight:900;">üî•</div>
                <h2 id="user-name" style="text-align:center;font-size:1.8rem;">‚Äî</h2>
                <p id="user-team" style="text-align:center;color:var(--gold);font-weight:700;margin-bottom:1.5rem;">√âquipe ‚Äî</p>

                <div style="font-size:0.9rem; margin-bottom:5px;">Objectif Session</div>
                <div class="progress-bar"><div id="session-fill" class="progress-fill"></div></div>
                
                <div style="font-size:0.9rem; margin-bottom:5px;">Objectif Semaine</div>
                <div class="progress-bar"><div id="week-fill" class="progress-fill" style="background:var(--gold)"></div></div>

                <textarea id="note" style="background:rgba(255,255,255,0.05);border:none;border-radius:15px;padding:1rem;color:#fff;resize:none;height:70px;margin-top:1rem;" placeholder="Une note client ?"></textarea>
                <button id="r1p-btn" onclick="takeR1P()">R1P +1</button>
            </div>

            <div style="display:grid;grid-template-rows:1fr 1fr;gap:1.5rem;">
                <div class="glass">
                    <h3 style="margin-bottom:1rem;color:var(--gold);">ü•á TOP HEBDO</h3>
                    <div id="indiv-week" style="overflow-y:auto; flex:1;"></div>
                </div>
                <div class="glass">
                    <h3 style="margin-bottom:1rem;color:var(--primary);">‚ö° SESSION LIVE</h3>
                    <div id="session-live" style="overflow-y:auto; flex:1;"></div>
                </div>
            </div>

            <div style="display:grid;grid-template-rows:1fr 1.5fr;gap:1.5rem;">
                <div class="glass">
                    <h3 style="margin-bottom:1rem;">üèÜ MOMENTUM VILLES</h3>
                    <div id="team-momentum" style="overflow-y:auto; flex:1;"></div>
                </div>
                <div class="glass">
                    <h3 style="margin-bottom:1rem;">üî• ACTIVIT√â</h3>
                    <div id="live-feed" style="overflow-y:auto; flex:1; font-size:0.85rem;"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const SUPABASE_URL = "https://ydcfjlogsbkmzzzkxvgo.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_zVqdL4T9-J9srWE88bAskQ_Pjqb75Fz";
        const ADMIN_KEY = "OOB2026";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const TEAM_MAP = {"sofia":"Caen","david":"Caen","kevin":"Caen","durmus":"Evreux","merwan":"Courbevoie","diassivi":"Courbevoie","sertag":"Courbevoie","roxanne":"Rouen"};
        const COMPLIMENTS = ["L√©gendaire, {name} ! üî•", "Quel monstre, {name} ! üèÜ", "BOOM ! {name} est imbattable.", "Magistral, {name} ! ‚ú®", "Le patron, c'est {name} !", "{name}, tu es en feu ! üöÄ"];

        let currentUser = {name:"", team:""};
        let lastClick = 0;

        function validatePrenom(){
            let p = document.getElementById("prenom-input").value.trim().toLowerCase();
            if(!TEAM_MAP[p]){ document.getElementById("login-error").textContent = "Pr√©nom inconnu."; return; }

            currentUser.name = p.charAt(0).toUpperCase() + p.slice(1);
            currentUser.team = TEAM_MAP[p];

            gsap.to("#login-modal", { duration: 0.8, y: "-100%", ease: "expo.inOut", onComplete: () => {
                document.getElementById("login-modal").style.display = "none";
                document.getElementById("main-app").style.display = "grid";
                gsap.to("#main-app", { opacity: 1, duration: 1 });
                refreshAll();
            }});

            document.getElementById("user-name").textContent = currentUser.name;
            document.getElementById("avatar").textContent = currentUser.name[0];
            document.getElementById("user-team").textContent = "√âquipe " + currentUser.team;
            setInterval(refreshAll, 10000);
        }

        async function takeR1P(){
            if(Date.now()-lastClick < 60000){ showToast("Patience {name}... (1 min)"); return; }

            const note = document.getElementById("note").value.trim();
            const { error } = await supabase.from('suivi_r1p').insert({
                auteur: currentUser.name, equipe: currentUser.team, note: note || null,
                semaine: new Date().toISOString().slice(0,10), mois: new Date().toISOString().slice(0,7)
            });

            if(!error){
                await updateCounter("Individuel", currentUser.name);
                await updateCounter("Equipe", currentUser.team);
                lastClick = Date.now();
                
                launchLuxuryConfetti();
                gsap.fromTo("#shake-container", {x:-4}, {x:4, duration:0.07, repeat:7, yoyo:true});
                
                const msg = COMPLIMENTS[Math.floor(Math.random()*COMPLIMENTS.length)].replace("{name}", currentUser.name);
                showToast(msg);
                speak(msg);
                
                document.getElementById("note").value = "";
                refreshAll();
            }
        }

        async function updateCounter(scope, key){
            let { data } = await supabase.from('r1p_counters').select('*').eq('scope', scope).eq('key', key).single();
            if(!data) { await supabase.from('r1p_counters').insert({scope, key, count_week:1, count_session:1}); }
            else { await supabase.from('r1p_counters').update({count_week: data.count_week+1, count_session: data.count_session+1}).eq('id', data.id); }
        }

        async function refreshAll(){
            const { data: indiv } = await supabase.from('r1p_counters').select('*').eq('scope','Individuel').order('count_week',{ascending:false});
            const { data: sess } = await supabase.from('r1p_counters').select('*').eq('scope','Individuel').order('count_session',{ascending:false});
            const { data: teams } = await supabase.from('r1p_counters').select('*').eq('scope','Equipe').order('count_week',{ascending:false});
            const { data: feed } = await supabase.from('suivi_r1p').select('*').order('created_at',{ascending:false}).limit(10);

            renderList("indiv-week", indiv || [], "count_week");
            renderList("session-live", sess || [], "count_session");
            renderList("team-momentum", teams || [], "count_week");
            renderFeed(feed || []);
            updateProgress(indiv, sess);
        }

        function renderList(id, items, field){
            document.getElementById(id).innerHTML = items.map((it, idx) => `
                <div class="feed-item">
                    <span>${idx+1}. <strong>${it.key}</strong></span>
                    <span style="font-weight:900; color:var(--gold)">${it[field]}</span>
                </div>`).join('');
        }

        function renderFeed(items){
            document.getElementById("live-feed").innerHTML = items.map(it => `
                <div class="feed-item" style="flex-direction:column; align-items:flex-start;">
                    <div style="width:100%; display:flex; justify-content:space-between;">
                        <strong>${it.auteur}</strong> <span style="opacity:0.4;">${new Date(it.created_at).toLocaleTimeString()}</span>
                    </div>
                    <div style="opacity:0.7; font-size:0.8rem;">${it.note || "Nouveau R1P !"}</div>
                </div>`).join('');
        }

        function updateProgress(indiv, sess){
            const myIndiv = indiv?.find(i => i.key === currentUser.name);
            const mySess = sess?.find(i => i.key === currentUser.name);
            if(myIndiv) document.getElementById("week-fill").style.width = Math.min((myIndiv.count_week / 8) * 100, 100) + "%";
            if(mySess) document.getElementById("session-fill").style.width = Math.min((mySess.count_session / 4) * 100, 100) + "%";
        }

        function showToast(msg){
            const t = document.getElementById("toast");
            t.innerHTML = msg; t.style.display = "block";
            gsap.fromTo(t, {scale:0.5, opacity:0}, {scale:1, opacity:1, duration:0.5, ease:"back.out"});
            setTimeout(() => gsap.to(t, {opacity:0, scale:0.8, duration:0.5, onComplete:()=>t.style.display="none"}), 3000);
        }

        function launchLuxuryConfetti(){
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#F7931E', '#ffffff', '#fbbf24'] });
        }

        function speak(text){
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'fr-FR'; msg.rate = 1.1; window.speechSynthesis.speak(msg);
        }

        function askAdminCode(){
            const code = prompt("üîë Code Admin :");
            if(code === ADMIN_KEY && confirm("R√©initialiser la session ?")){
                supabase.from('r1p_counters').update({count_session:0}).gt('count_session',-1).then(()=>location.reload());
            }
        }
    </script>
</body>
</html>
