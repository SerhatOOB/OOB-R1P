// ========================================
// CONFIGURATION & MESSAGES DE GRATIFICATION
// ========================================
const GRATIFICATION_MESSAGES = [
    "Incroyable, {name} ! T'es une vÃ©ritable machine ! ðŸ”¥",
    "Direct dans l'Ã©lite, {name}. Quel talent exceptionnel ! ðŸ†",
    "BOOM ! {name}, tu domines littÃ©ralement le game.",
    "Le patron, c'est {name} ! Un R1P de pur gÃ©nie. âœ¨",
    "La concurrence tremble devant {name} ! Quelle puissance !",
    "Magnifique, {name} ! L'excellence Ã  l'Ã©tat pur.",
    "Rien ne t'arrÃªte, {name} ! Le sommet t'attend. ðŸš€",
    "Respect, {name}. On reconnaÃ®t la signature des plus grands.",
    "Encore un ? {name}, tu es en plein 'God Mode' ! âš¡",
    "C'est Ã§a qu'on veut voir ! Bravo {name}, magistral !"
];

const SUPABASE_URL = "https://ydcfjlogsbkmzzzkxvgo.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_zVqdL4T9-J9srWE88bAskQ_Pjqb75Fz";
const ADMIN_SECRET = "OOB2026";
const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const TEAM_MAP = {
    "sofia":"Caen","david":"Caen","kevin":"Caen",
    "durmus":"Evreux","merwan":"Courbevoie",
    "diassivi":"Courbevoie","sertag":"Courbevoie","roxanne":"Rouen"
};

let currentUser = {name:"", team:""};
let lastR1P = 0;

// ========================================
// LOGIQUE DE CONNEXION
// ========================================
function validatePrenom() {
    let p = document.getElementById("prenom-input").value.trim().toLowerCase();
    if(p === ADMIN_SECRET.toLowerCase()) { resetSession(); return; }
    if(!TEAM_MAP[p]) { document.getElementById("login-error").textContent = "IdentitÃ© non reconnue dans l'Ã©lite."; return; }

    currentUser.name = p.charAt(0).toUpperCase() + p.slice(1);
    currentUser.team = TEAM_MAP[p];

    gsap.to("#login-modal", { duration: 1, y: "-100%", ease: "expo.inOut", onComplete: () => {
        document.getElementById("login-modal").style.display = "none";
        document.getElementById("main-app").style.display = "grid";
        gsap.to("#main-app", { opacity: 1, duration: 1.5 });
    }});

    document.getElementById("user-name").textContent = currentUser.name;
    document.getElementById("avatar").textContent = currentUser.name[0];
    document.getElementById("user-team").textContent = "Team " + currentUser.team;
    
    refreshAll();
    setInterval(refreshAll, 10000);
}

// ========================================
// ACTION R1P + ANIMATIONS HAUTE COUTURE
// ========================================
async function takeR1P() {
    // Anti-spam de 60 secondes
    if(Date.now() - lastR1P < 60000) { 
        showToast("â³ Un peu de patience, {name}... Chaque chef-d'Å“uvre prend du temps."); 
        return; 
    }
    
    const note = document.getElementById("note").value.trim();
    
    // Insertion Base de donnÃ©es
    const { error } = await supabaseClient.from('suivi_r1p').insert({
        auteur: currentUser.name, 
        equipe: currentUser.team, 
        note: note || null,
        semaine: new Date().toISOString().slice(0,10), 
        mois: new Date().toISOString().slice(0,7)
    });

    if(!error) {
        await updateCounter("Individuel", currentUser.name);
        await updateCounter("Equipe", currentUser.team);
        
        lastR1P = Date.now();
        
        // --- LA SÃ‰QUENCE DE GRATIFICATION ---
        
        // 1. On choisit un message alÃ©atoire
        const template = GRATIFICATION_MESSAGES[Math.floor(Math.random() * GRATIFICATION_MESSAGES.length)];
        const personalMsg = template.replace("{name}", currentUser.name);
        
        // 2. On lance les feux d'artifice
        launchLuxuryConfetti();
        
        // 3. On affiche le message flatteur
        showToast(personalMsg);
        
        document.getElementById("note").value = "";
        refreshAll();
    } else {
        showToast("âš ï¸ Erreur de liaison avec la base, {name}. RÃ©essaie.");
    }
}

// ========================================
// UI & EFFETS VISUELS
// ========================================
function showToast(msg) {
    const t = document.getElementById("toast");
    
    // On nettoie les styles pour Ã©viter les bugs de superposition
    t.style.display = "block";
    t.innerHTML = msg;
    
    // Animation GSAP Elite (Apparition centrale avec rebond)
    gsap.fromTo(t, 
        { scale: 0.5, y: 100, opacity: 0 }, 
        { scale: 1, y: 0, opacity: 1, duration: 0.7, ease: "back.out(1.7)" }
    );

    // Disparition en douceur aprÃ¨s 4 secondes
    setTimeout(() => {
        gsap.to(t, { opacity: 0, scale: 0.8, duration: 0.5, onComplete: () => t.style.display = "none" });
    }, 4000);
}

function launchLuxuryConfetti() {
    const colors = ['#F7931E', '#ffffff', '#fbbf24'];

    // Fontaine gauche
    confetti({ particleCount: 40, angle: 60, spread: 70, origin: { x: 0, y: 0.7 }, colors: colors });
    // Fontaine droite
    confetti({ particleCount: 40, angle: 120, spread: 70, origin: { x: 1, y: 0.7 }, colors: colors });
    
    // Explosion centrale massive aprÃ¨s 200ms
    setTimeout(() => {
        confetti({
            particleCount: 150,
            spread: 100,
            origin: { y: 0.5 },
            colors: colors,
            scale: 1.2,
            gravity: 0.8
        });
    }, 200);
}

// ... (Reste des fonctions updateCounter, refreshAll, renderList, renderFeed identiques)
