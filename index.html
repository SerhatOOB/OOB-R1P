<script>
    const SUPABASE_URL = "https://ydcfjlogsbkmzzzkxvgo.supabase.co";
    // ATTENTION : V√©rifie bien cette cl√© dans ton dashboard Supabase (Project Settings > API)
    const SUPABASE_ANON_KEY = "sb_publishable_zVqdL4T9-J9srWE88bAskQ_Pjqb75Fz"; 
    const ADMIN_KEY = "OOB2026";
    
    // Initialisation s√©curis√©e
    let supabaseClient;
    try {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (e) {
        console.error("Erreur d'initialisation Supabase:", e);
    }

    const TEAM_MAP = {"sofia":"Caen","david":"Caen","kevin":"Caen","durmus":"Evreux","merwan":"Courbevoie","diassivi":"Courbevoie","sertag":"Courbevoie","roxanne":"Rouen"};
    const COMPLIMENTS = ["L√©gendaire, {name} ! üî•", "Quel monstre, {name} ! üèÜ", "BOOM ! {name} est imbattable.", "Magistral, {name} ! ‚ú®", "Le patron, c'est {name} !", "{name}, tu es en feu ! üöÄ"];

    let currentUser = {name:"", team:""};
    let lastClick = 0;

    function validatePrenom() {
        let input = document.getElementById("prenom-input");
        let p = input.value.trim().toLowerCase();
        
        if(!TEAM_MAP[p]) { 
            document.getElementById("login-error").textContent = "Pr√©nom non r√©pertori√©."; 
            return; 
        }

        currentUser.name = p.charAt(0).toUpperCase() + p.slice(1);
        currentUser.team = TEAM_MAP[p];

        // Transition d'√©cran
        gsap.to("#login-modal", { duration: 0.8, y: "-100%", ease: "expo.inOut", onComplete: () => {
            document.getElementById("login-modal").style.display = "none";
            const mainApp = document.getElementById("main-app");
            mainApp.style.display = "grid";
            gsap.to(mainApp, { opacity: 1, duration: 1 });
        }});

        // Mise √† jour interface
        document.getElementById("user-name").textContent = currentUser.name;
        document.getElementById("avatar").textContent = currentUser.name[0];
        document.getElementById("user-team").textContent = "√âquipe " + currentUser.team;
        
        // On lance le refresh mais on ne bloque pas si Supabase est mal configur√©
        refreshAll().catch(err => console.log("Mode d√©connect√© ou erreur cl√© API"));
        setInterval(refreshAll, 10000);
    }

    async function refreshAll() {
        if(!supabaseClient) return;
        try {
            const { data: indiv } = await supabaseClient.from('r1p_counters').select('*').eq('scope', 'Individuel').order('count_week', {ascending: false}).limit(10);
            const { data: sess } = await supabaseClient.from('r1p_counters').select('*').eq('scope', 'Individuel').order('count_session', {ascending: false}).limit(10);
            const { data: teams } = await supabaseClient.from('r1p_counters').select('*').eq('scope', 'Equipe').order('count_week', {ascending: false});
            const { data: feed } = await supabaseClient.from('suivi_r1p').select('*').order('created_at', {ascending: false}).limit(12);

            if(indiv) renderList("indiv-week", indiv, "count_week");
            if(sess) renderList("session-live", sess, "count_session");
            if(teams) renderList("team-momentum", teams, "count_week");
            if(feed) renderFeed(feed);
        } catch(e) { 
            console.error("Erreur de rafra√Æchissement des donn√©es"); 
        }
    }

    // Garde le reste de tes fonctions (renderList, renderFeed, takeR1P, etc.) √† l'identique ici...
    function renderList(id, items, field) {
        const container = document.getElementById(id);
        if(!container) return;
        container.innerHTML = items.map((it, idx) => `
            <div class="feed-item ${idx < 3 ? 'top-3' : ''}">
                <span>${idx+1}. <strong>${it.key}</strong></span>
                <span style="font-weight:900; color:var(--gold)">${it[field]}</span>
            </div>
        `).join('');
    }
    // ... Copie/colle la suite de tes fonctions d'origine ...
    function renderFeed(items) {
        document.getElementById("live-feed").innerHTML = items.map(it => `
            <div class="feed-item" style="flex-direction:column; align-items:flex-start;">
                <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:4px;">
                    <strong style="color:var(--primary)">${it.auteur}</strong> 
                    <span style="opacity:0.4; font-size:0.75rem;">${new Date(it.created_at).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}</span>
                </div>
                <div style="opacity:0.7; font-style:italic;">${it.note || "Nouveau R1P valid√© !"}</div>
            </div>
        `).join('');
    }
    function showToast(msg) {
        const t = document.getElementById("toast");
        t.innerHTML = msg; t.style.display = "block";
        gsap.fromTo(t, { scale: 0.5, opacity: 0, y: 50 }, { scale: 1, opacity: 1, y: 0, duration: 0.5, ease: "back.out(1.7)" });
        setTimeout(() => {
            gsap.to(t, { opacity: 0, scale: 0.8, duration: 0.4, onComplete: () => t.style.display = "none" });
        }, 3000);
    }
    window.onload = () => document.getElementById("prenom-input").focus();
</script>
